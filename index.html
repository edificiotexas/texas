<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edifício Texas</title>
    <link rel="stylesheet" href="css/estilo.css">
    <link rel="stylesheet" href="css/dashboard.css">
</head>
<body>
    <header class="header">
        <div class="header-brand">
            <img src="img/80texas.webp" alt="Logo" class="header-logo">
            <h1>Edifício Texas</h1>
        </div>
        <button onclick="sair()">Sair</button>
    </header>

    <nav class="menu">
        <a href="index.html" class="active">Início</a>
        <a href="avisos.html">Avisos</a>
        <a href="agenda.html">Agenda</a>
        <a href="moradores.html">Moradores</a>
    </nav>

    <main class="main-content">
        <h2>Bem-vindo, <span id="nomeUsuario"></span></h2>
        <div class="cards">
            <div class="card" onclick="window.location.href='avisos.html'">
                <h3>Avisos</h3>
                <p>Comunicados e avisos em geral.</p>
            </div>
            <div class="card" onclick="window.location.href='reserva-visitantes.html'">
                <h3>Vagas para Visitantes</h3>
                <p>Reserve vagas para seus visitantes.</p>
            </div>
            <div class="card" onclick="window.location.href='moradores.html'">
                <h3>Moradores</h3>
                <p>Conheça seus vizinhos.</p>
            </div>
            <div class="vaga-visitante-info">
                <h3>Sua Vaga para Visitantes</h3>
                <div id="vagaVisitanteInfo">
                    <p>Carregando informações da vaga...</p>
                </div>
            </div>
        </div>
    </main>

    <script src="js/auth.js"></script>
    <script>
        // Verificar se está logado
        const usuario = JSON.parse(localStorage.getItem('usuario'));
        if (!usuario) {
            window.location.href = 'login.html';
        } else {
            document.getElementById('nomeUsuario').textContent = usuario.nome;
            carregarInfoVagaVisitante();
        }

        async function carregarInfoVagaVisitante() {
            try {
                const apto = usuario.apartamento + usuario.bloco;
                const response = await fetch(`https://condominio-cc5u.onrender.com/api/vagas-visitantes/por-apartamento/${apto}`);
                const vagas = await response.json();
                
                const hoje = new Date();
                const vagaProxima = vagas.find(vaga => new Date(vaga.dataInicio) >= hoje) || vagas[0];
                
                const container = document.getElementById('vagaVisitanteInfo');
                
                if (vagaProxima) {
                    const dataFormatada = new Date(vagaProxima.dataInicio).toLocaleDateString('pt-BR');
                    const vagaNumero = vagaProxima.vaga1 === apto ? '01' : '02';
                    
                    container.innerHTML = `
                        <p class="vaga-disponivel">Você tem direito à vaga na semana ${vagaProxima.semana}</p>
                        <p>Data de início: ${dataFormatada}</p>
                        <p>Vaga designada: ${vagaNumero}</p>
                        ${new Date(vagaProxima.dataInicio) <= hoje ? 
                            '<p class="vaga-disponivel">✅ Vaga disponível esta semana!</p>' : 
                            '<p class="vaga-indisponivel">⏳ Aguardando liberação</p>'}
                    `;
                } else {
                    container.innerHTML = '<p class="vaga-indisponivel">Não há vagas programadas para seu apartamento.</p>';
                }
            } catch (error) {
                console.error('Erro ao carregar info da vaga:', error);
                document.getElementById('vagaVisitanteInfo').innerHTML = 
                    '<p>Erro ao carregar informações da vaga. Tente novamente mais tarde.</p>';
            }
        }

        function sair() {
            localStorage.removeItem('usuario');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>